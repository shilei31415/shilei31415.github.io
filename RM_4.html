<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--========== The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags ==========-->
    <title>视觉代码讲解(四)</title>

    <!--==========Dependency============-->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="vendors/owl-carousel/assets/owl.carousel.css">
    <link rel="stylesheet" href="vendors/magnific-popup/magnific-popup.css">
    <link rel="stylesheet" href="vendors/flexslider/flexslider.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kanit:500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:600,700italic">
    <link href='https://fonts.googleapis.com/css?family=Dosis:400,200,300,500,600,800,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Muli:400,300,300italic,400italic">
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500italic,500,700italic,700,900,900italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Fredoka+One' rel='stylesheet' type='text/css'>

    <!--==========Theme Styles==========-->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/theme/green.css" rel="stylesheet">

    <!--========== HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries ==========-->
    <!--========== WARNING: Respond.js doesn't work if you view the page via file:// ==========-->
    <!--==========[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]==========-->
</head>
<style>
    .Black{
        background-color: green;
    }
</style>
<body>

<header class="row transparent white" data-spy="affix" data-offset-top="300" id="header">
    <div class="container">
        <div class="row top-header">
            <div class="col-sm-4 search-form-col">
                <form action="#" method="get" class="search-form">
                    <div class="input-group">
                        <img src="images/stone2.png" alt="">
                    </div>
                </form>
            </div>
            <div class="col-sm-4 logo-col text-center">
                <h3>3 Stones</h3>
            </div>
            <div class="col-sm-4 menu-trigger-col">
                <button class="menu-trigger black pull-right">
                    <span class="active-page">Blog Details</span>
                    <img src="images/menu-align-dark.png" alt="" class="icon-burger">
                    <img src="images/menu-close-dark.png" alt="" class="icon-cross">
                </button>
            </div>
        </div>
    </div>
    <div class="row menu-section">
        <div class="container">
            <div class="row">
                <div class="col-sm-8 menu-col">
                    <div class="row">
                        <ul class="nav column-menu white-bg">
                            <li class="active dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Home <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li><a href="index.html">Home</a></li>
                                    <li><a href="index2.html">2020-6月</a></li>
                                    <li><a href="index3.html">Home Option 3</a></li>
                                    <li><a href="index4.html">Home Option 4</a></li>
                                    <li><a href="index5.html">Home Option 5</a></li>
                                    <li><a href="index6.html">Home Option 6</a></li>
                                </ul>
                            </li>
                            <li><a href="resume.html">resume(个人简历)</a></li>
                            <li><a href="single.html">my memery(我的回忆)</a></li>
                            <li><a href="single2.html">my store(我的小店)</a></li>
                        </ul>
                        <ul class="nav column-menu white-bg">
                            <li><a href="single3.html">I'm reading(最近在读)</a></li>
                            <li><a href="single3.html">I'm doing(最近在做)</a></li>
                            <li><a href="https://github.com/shilei31415">github</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-4 subscribe-col">
                </div>
            </div>
        </div>
    </div>
</header>

<section class="row content-wrap">
    <div class="container">
        <div class="row">
            <div class="col-md-8 single-post-contents">
                <article class="single-post-content row m0 post">
                    <header class="row">
                        <h5 class="post-meta">
                            <a class="date">2020 8 29</a>
                            <span class="post-author"><i>by</i><a href="resume.html">施磊</a></span>
                        </h5>
                        <h2 class="post-title">不仅仅是识别那么简单</h2>
                        <div class="row">
                            <h5 class="taxonomy pull-left"><i>in</i> <a href="#">坐标变换</a> <a href="#">OpenCV</a></h5>
                        </div>
                    </header>
                    <div class="post-content row">
                        <h4>
                            坐标变换
                        </h4>
                        <p>
                            希望学弟们在看本文之前先把线性代数学好
                        </p>
                        <h3>
                            1.坐标变换
                        </h3>
                        <p>
                            其实,从物体的坐标(x,y,z)对应到图像中的坐标(x,y),经历了两次坐标变换,一共涉及到三个坐标系(分别是: 世界坐标系, 相机坐标系, 图像平面坐标系),
                            三者具体是啥, 相互之间怎么转换, 可以参考-><a href="https://www.bilibili.com/video/BV1C54y1B7By?from=search&seid=7393549921458883085">相机标定</a><br>
                        </p>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_16.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <h3>
                            2.相机标定
                        </h3>
                        <p>
                            了解了CV中的各种坐标系之后, 标定就是测量相机坐标系到图像平面坐标系的变换矩阵(相机矩阵), 以及衡量图像畸变的畸变矩阵, 二者合称内参, 只与相机有关.
                            世界坐标系到相机坐标系的变换矩阵显然与相机姿态有关, 被称为外参.<br>
                            只要是将CV算法应用到实际, 都要涉及到相机标定. 具体标定代码, 可以参考:<a href="https://blog.csdn.net/czhzasui/article/details/83273380">OpenCV相机标定</a>, 当然也可以直接看我的代码.<br>
                            网上大部分标定教程都是为了校正图像的畸变, 我们则是为了后续的坐标变换, 为了PnP, 在我测试过程中, 图像几乎没有畸变, 不需要校正, 提高帧率.
                        </p>
                        <h3>
                            3.PnP(Perspective-n-Point)
                        </h3>
                        <p>
                            PnP是一种算法,不是三极管!!!! 具体原理参考: <a href="https://blog.csdn.net/u014709760/article/details/88029841">PnP 算法原理</a>
                            看看原理就好, 看看他怎么调用OpenCV的.<br>
                            PnP可以求出R, T, R表示世界坐标系怎样旋转可以变为相机坐标系, T表示世界坐标系的原点需要怎样平移能与相机坐标系重合.<br>
                            如果我们将世界坐标系与我们要击打的装甲板进行固连(以装甲板的中心点为世界坐标系原点, 以装甲板长方向为X周, 宽方向为Y轴, 垂直装甲板面向外为Z轴),
                            当然这里只是我使用的方式, 还可以是其他, 以下为具体实现, 只需算出在你定义的世界坐标系下,各个特征点的坐标即可.
                        </p>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_18.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <p>
                            此时, T便可以理解为: 在相机坐标系下的装甲板中心坐标. (重点, 下文要用到的)
                        </p>
                        <h3>
                            4.机器人坐标系
                        </h3>
                        <p>
                            假如我们已经准确识别到了对手, 对方没动, 而我方因为自瞄,操作手走位, 导致我方机器人姿态变换, 必然会造成敌方装甲板在图像中的位置变化,
                            此时, 如果你使用装甲板的像素坐标的变化对敌方装甲进行预测, 基本不可能正确.(敌方未动, 而你却觉得动了, 效果肯定不好). <br>
                            引入"机器人坐标系"(瞎编的概念,不学术), 机器人初始化时!!!!!, 枪口水平向前(为Z轴), 垂直于枪管向右,向下为X轴和Y轴, 各轴方向不随机器人(pitch,yaw)而变化, 不转动仅平动. <br>
                            这么定义的目的:<br>
                            ① 初始状态, 电控初始化, 枪口水平朝向正前方(电控给视觉发送的pitch=0,yaw=0), 机器人坐标系与摄像头坐标系几乎重合(各轴相互平行, 原点不一定重合);<br>
                            ② 运动时, 电控发送给视觉的pitch≠0,yaw≠0, (pitch为俯仰角), pitch和yaw就表示了摄像头坐标系到机器人坐标系的变换关系
                            (pitch为0时, yaw代表摄像头坐标系X与机器人坐标系X的夹角, yaw为0时, pitch表示摄像头坐标系Z与机器人坐标系Z的夹角),当时推了一下午得到如下变换矩阵:
                        </p>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_17.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <p>
                            后来发现具体推导可以参考CV中世界坐标系与相机坐标系的变换, 也可以直接用"罗德里格斯变换", 我还是菜了<br>
                            使用该矩阵将PnP结果变为"机器人坐标系"下的坐标, 由于机器人坐标系不转动仅平动, 使用该坐标可以排除机器人pitch轴与yaw轴转动对预测带来的误差.<br>
                            机器人平动造成的误差不应该考虑(具体为啥, 参考大学物理)<br>
                            使用该方法预测敌方, 可以得到地方下一时刻的机器人坐标, 在用逆矩阵变为相机坐标, 乘相机矩阵得到像素坐标
                        </p>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_19.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <h4>
                            注意事项:
                        </h4>
                        <p>
                            进行了上述骚操作, 可以将预测结果画至图中, 无论自己动还是不动, 只要敌方不动, 预测结果就与装甲板中心重合(即与世界坐标系原点重合);<br>
                            预测结果, 可能存在抖动, 与pitch, yaw, 装甲板的像素坐标测量不准有关.
                        </p>
                        <h3>
                            5.kalman滤波
                        </h3>
                        <p>
                            kalman虽然属于信号处理, 但OpenCV有相关函数. 具体原理吃了线代的亏,没看懂. 只会写个状态转移矩阵. 希望大家不要像我一样, 只有搞懂原理才有可能把他发挥到极致<br>
                            简单说一下我怎么用kalman的. 前面说过预测存在抖动, kalman就可以解决. 你可以在预测前对输入数据(装甲的像素坐标)进性滤波, 也可以在也测后滤波,
                            甚至两次都滤波(我采用了两次都滤的方法)<br>
                            需要能通过识别程序得知是否切换目标, 每次切换目标需要对kalman中的数据(除了状态转移矩阵)进行初始化, 否则相当于告诉滤波器"目标发生瞬移",
                            通常这严重违背状态转移矩阵, 会造成切换目标后的前10帧数据误差极大, 以下分别为"变换目标就初始化"(上)和"变换目标不初始化"(下),其余参数相同,
                            紫色为滤波后, 绿色为滤波前.
                        </p>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_20.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <div class="col-sm-12">
                            <img src="images/RM/pic_21.png" alt="loading picture" class="img-thumbnail">
                        </div>
                        <h3>
                            6.空气阻力
                        </h3>
                        <p>
                            上赛季花了大量时间研究空气阻力, 最后也没搞出什么, 我使用F正比于V^2, 做了数值模拟, 并测量了实际曲线, 并不是很理想; 感兴趣的可以再试一试<br>
                            随着弹丸的速度下降, 滞空时间延长, 抛物线越发明显, 空气阻力的影响加大, 如何根据目标距离, 子弹射速, 计算仰角将越来越难.<br>
                            省赛尝试使用matlab拟合仰角, 子弹速度, 目标距离之间的关系, 效果不错, 建议使用<br>
                            但要注意:<br>
                            ① 电控需要保证子弹射速稳定; 不因电量, 电压而变化; 连发速度下降不明显;
                            ② 如果电控和结构做的特别好, 可以保证摩擦轮转速, 与子弹射速存在稳定关系, 可以直接拟合"仰角, 摩擦轮转速, 目标距离";
                            ③ 数据越多越准确, 尽量覆盖可能使用到的范围.
                        </p>
                        <h3>
                            7.其他
                        </h3>
                        <p>
                            关于串口通信提一个我个人觉得好用的方法: 如果发现, 机器人枪口需要较长时间才能到达指定方向, 到达指定方向后有需要较长时间才能稳定(不抖动),
                            可以尝试将串口数据变为原来的3次方并乘一定系数, 保证正负号的同时, 放大较远时的偏移量, 缩小较近时的偏移量.
                        </p>
                    </div>
                </article>
            </div>

            <!--Author Widget-->
            <div class="col-md-4 sidebar">
                <aside class="row m0 widget-author widget">
                    <div class="widget-author-inner row">
                        <div class="author-avatar row"><a href="#"><img src="images/author.jpg" alt="" class="img-circle"></a></div>
                        <a href="#"><h2 class="author-name">施磊</h2></a>
                        <h5 class="author-title">以老王卖瓜的方式讲解自己的代码</h5>
                        <p>2020赛季以答辩形式结束,学弟们没能积攒到足够的经验,希望这些博客能给予你们帮助,相信你们能写出更棒的</p>
                        <a href="resume.html" class="taxonomy" style="font-size: 15pt">resume</a>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>

<!--Footer-->
<footer class="row" id="footer">
    <div class="container">
        <div class="row top-footer">
            <div class="widget col-sm-3 widget-about" >
                <h3>3 Stones</h3>
            </div>
            <div class="widget col-sm-5 widget-menu">
                <div class="row">
                    <ul class="nav column-menu white-bg">
                        <li class="active"><a href="index.html">Home</a></li>
                        <li><a href="resume.html">resume</a></li>
                        <li><a href="single.html">my memery</a></li>
                        <li><a href="single2.html">my store</a></li>
                    </ul>
                    <ul class="nav column-menu white-bg">
                        <li><a href="single3.html">I'm reading</a></li>
                        <li><a href="single3.html">I'm doing</a></li>
                        <li><a href="https://github.com/shilei31415">github</a></li>
                    </ul>
                </div>
            </div>
            <div class="widget col-sm-4 widget-subscribe">

            </div>
        </div>
        <h5 class="copyright">Thanks for <a target="_blank" href="http://sc.chinaz.com/moban/">&#x7F51;&#x9875;&#x6A21;&#x677F;</a></h5>
    </div>
</footer>

<!--========== jQuery (necessary for Bootstrap's JavaScript plugins) ==========-->
<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="vendors/owl-carousel/owl.carousel.min.js"></script>
<script src="vendors/magnific-popup/jquery.magnific-popup.min.js"></script>
<script src="vendors/instafeed/instafeed.min.js"></script>
<script src="vendors/imagesLoaded/imagesloaded.pkgd.min.js"></script>
<script src="vendors/isotope/isotope.pkgd.min.js"></script>
<script src="vendors/flexslider/jquery.flexslider-min.js"></script>
<script src="js/theme.js"></script>
</body>
</html>
